<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>

<style>
body {
  font-family: Arial;
  background: #f4f6f9;
  padding: 30px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

h2 {
  color: #333;
}

button {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin: 2px;
}

.primary { background:#007bff; color:white; }
.success { background:#28a745; color:white; }
.danger { background:#dc3545; color:white; }

.logout {
  background:#444;
  color:white;
}

#syncStatus {
  margin-top:10px;
  font-weight:bold;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  margin-top: 20px;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #ddd;
}

th {
  background: #343a40;
  color: white;
}

tr:hover {
  background: #f1f1f1;
}
</style>
</head>

<body>

<div class="header">
  <h2>Admin â€“ Sales User Management</h2>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<br>

<button id="syncBtn" class="primary" onclick="sync()">Sync Salesforce</button>
<div id="syncStatus"></div>

<table>
<thead>
<tr>
<th>Name</th>
<th>Email</th>
<th>Phone</th>
<th>Status</th>
<th>Password</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<script>

/* =====================================================
   SESSION CHECK
===================================================== */

const sessionId = localStorage.getItem("sessionId");

if (!sessionId) {
  window.location = "login.html";
}

/* =====================================================
   AUTO LOGOUT AFTER 15 MINUTES
===================================================== */

setTimeout(() => {
  alert("Session expired. Please login again.");
  logout();
}, 15 * 60 * 1000);

/* =====================================================
   LOAD USERS
===================================================== */

function load() {

  fetch('/api/users', {
    headers: { sessionid: sessionId }
  })
  .then(res => {
    if (res.status === 401) logout();
    return res.json();
  })
  .then(data => {

    let html = '';

    data.forEach(u => {

      html += `
      <tr>
        <td>${u.firstname} ${u.lastname}</td>
        <td>${u.emailid}</td>
        <td>${u.phone || ''}</td>
        <td>${u.status}</td>
        <td>
          <button onclick="resetPassword('${u.salesforce_id}')">
            Reset
          </button>
        </td>
        <td>
          <button class="success"
            onclick="changeStatus('${u.salesforce_id}','Active')">
            Activate
          </button>

          <button class="danger"
            onclick="changeStatus('${u.salesforce_id}','Inactive')">
            Deactivate
          </button>
        </td>
      </tr>`;
    });

    document.getElementById('body').innerHTML = html;

  })
  .catch(() => logout());
}

/* =====================================================
   SYNC WITH PROGRESS
===================================================== */

function sync() {

  const btn = document.getElementById("syncBtn");
  const status = document.getElementById("syncStatus");

  btn.disabled = true;
  status.style.color = "#333";
  status.innerHTML = "ðŸ”„ Connecting to Salesforce...";

  fetch('/api/sync', {
    method: 'POST',
    headers: { sessionid: sessionId }
  })
  .then(res => {
    if (res.status === 401) logout();
    return res.json();
  })
  .then(data => {

    if (!data.success) {
      status.style.color = "red";
      status.innerHTML = "âŒ Sync Failed: " + (data.message || "Unknown error");
      btn.disabled = false;
      return;
    }

    status.style.color = "green";
    status.innerHTML =
      `âœ… Sync Completed | Fetched: ${data.totalFetched} | Saved: ${data.totalSaved}`;

    btn.disabled = false;
    load(); // Refresh table

  })
  .catch(err => {
    status.style.color = "red";
    status.innerHTML = "âŒ Sync Error occurred";
    btn.disabled = false;
  });
}

/* =====================================================
   CHANGE STATUS
===================================================== */

function changeStatus(id, statusValue) {

  fetch('/api/status', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      sessionid: sessionId
    },
    body: JSON.stringify({ id, status: statusValue })
  })
  .then(res => {
    if (res.status === 401) logout();
    return res.json();
  })
  .then(() => load());
}

/* =====================================================
   RESET PASSWORD
===================================================== */

function resetPassword(id) {

  let pwd = prompt("Enter New Password:");
  if (!pwd) return;

  fetch('/api/password', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      sessionid: sessionId
    },
    body: JSON.stringify({ id, password: pwd })
  })
  .then(res => {
    if (res.status === 401) logout();
    return res.json();
  })
  .then(() => alert("Password Updated"));
}

/* =====================================================
   LOGOUT
===================================================== */

function logout() {

  fetch('/api/logout', {
    method: 'POST',
    headers: { sessionid: sessionId }
  })
  .then(() => {
    localStorage.clear();
    window.location = "login.html";
  });
}

/* =====================================================
   PREVENT BACK BUTTON ACCESS
===================================================== */

window.history.pushState(null, null, window.location.href);
window.onpopstate = function () {
  window.history.go(1);
};

load();

</script>

</body>
</html>
