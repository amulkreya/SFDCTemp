<!DOCTYPE html>
<html>
<head>
  <title>Admin Home</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    button {
      padding: 8px 14px;
      margin-bottom: 15px;
      cursor: pointer;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    #status {
      margin: 10px 0;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h2>Salesforce Contacts (Admin)</h2>

  <!-- Sync Button -->
  <button onclick="syncSalesforce()">üîÑ Sync Salesforce Contacts</button>

  <!-- Status Message -->
  <div id="status"></div>

  <!-- Data Table -->
  <table>
    <thead>
      <tr>
        <th>Salesforce ID</th>
        <th>Email</th>
        <th>Username</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Role</th>
        <th>Active</th>
      </tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>

  <script>
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("sessionId");

    if (!sessionId) {
      alert("Session expired. Please login again.");
      window.location.href = "/login.html";
    }

    // Load users from DB
    function loadUsers() {
      fetch(`/api/users?sessionId=${sessionId}`)
        .then(res => {
          if (!res.ok) throw new Error("Unauthorized");
          return res.json();
        })
        .then(data => {
          const table = document.getElementById("userTable");
          table.innerHTML = "";

          data.forEach(user => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${user.salesforce_id || ""}</td>
              <td>${user.emailid || ""}</td>
              <td>${user.username || ""}</td>
              <td>${user.firstname || ""}</td>
              <td>${user.lastname || ""}</td>
              <td>${user.role}</td>
              <td>${user.active}</td>
            `;
            table.appendChild(row);
          });
        })
        .catch(err => {
          alert("Session expired or unauthorized. Please login again.");
          window.location.href = "/login.html";
        });
    }

    // Sync Salesforce contacts
    function syncSalesforce() {
      const status = document.getElementById("status");
      status.innerText = "üîÑ Syncing Salesforce contacts...";

      fetch("/api/sync-salesforce", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId })
      })
        .then(res => res.json())
        .then(data => {
          status.innerText =
            `‚úÖ Sync completed. Fetched: ${data.totalFetched}, Inserted: ${data.inserted}`;
          loadUsers();
        })
        .catch(err => {
          status.innerText = "‚ùå Sync failed. Check logs.";
        });
    }

    // Initial load
    loadUsers();
  </script>
</body>
</html>
