<!DOCTYPE html>
<html>
<head>
  <title>Admin Home</title>
  <style>
    body { font-family: Arial, sans-serif; }
    button { padding: 8px 14px; margin-right: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f4f4f4; }
    #status { margin-top: 15px; font-weight: bold; }
  </style>
</head>

<body>

<h2>Salesforce ‚Üí PostgreSQL Sync (Admin)</h2>

<button onclick="syncSalesforce()">üîÑ Sync Salesforce</button>
<button onclick="loadUsers()">üîÅ Refresh Table</button>

<div id="status"></div>

<table>
  <thead>
    <tr>
      <th>Salesforce ID</th>
      <th>Email</th>
      <th>Username</th>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Role</th>
      <th>Active</th>
    </tr>
  </thead>
  <tbody id="userTable"></tbody>
</table>

<script>
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get("sessionId");

  if (!sessionId) {
    alert("Session expired. Please login again.");
    window.location.href = "/login.html";
  }

  function setStatus(msg) {
    document.getElementById("status").innerText = msg;
  }

  /* ---- Load Table Data ---- */
  function loadUsers() {
    setStatus("üìÑ Loading data from PostgreSQL...");
    fetch(`/api/users?sessionId=${sessionId}`)
      .then(res => res.json())
      .then(data => {
        const table = document.getElementById("userTable");
        table.innerHTML = "";
        data.forEach(u => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${u.salesforce_id || ""}</td>
            <td>${u.emailid || ""}</td>
            <td>${u.username || ""}</td>
            <td>${u.firstname || ""}</td>
            <td>${u.lastname || ""}</td>
            <td>${u.role}</td>
            <td>${u.active}</td>
          `;
          table.appendChild(row);
        });
        setStatus("‚úÖ Table refreshed from PostgreSQL");
      });
  }

  /* ---- Sync Salesforce ---- */
  function syncSalesforce() {
    setStatus("üîê Connecting to Salesforce...");
    fetch("/api/sync-salesforce", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId })
    })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          setStatus("‚ùå Sync failed");
          return;
        }

        setStatus(
          `‚úÖ Sync completed | Salesforce OK | Contacts fetched: ${data.steps.contactsFetched} | Inserted into DB: ${data.steps.rowsInserted}`
        );

        loadUsers();
      })
      .catch(() => {
        setStatus("‚ùå Sync error. Check logs.");
      });
  }

  /* Initial load */
  loadUsers();
</script>

</body>
</html>
